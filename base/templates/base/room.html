{% extends 'base/main.html' %}
{% load static %}

{% block content %}

<main class="room-container">

    <!-- Popup for Host to approve/deny joining users -->
    <div id="approval-popup" class="popup hidden">
        <div class="popup-header">
            <img src="{% static 'images/warning-icon.png' %}" alt="Warning Icon" class="popup-icon">
            <h3>Confirm Member Join</h3>
            <div id="request-list"></div>
        </div>
    </div>


    <section id="room-name-wrapper" style="margin: 1em;">
        <p style="color: white;">Room: <span id="room-name"></span></p>
    </section>

    <section id="video-streams"></section>

    <section id="controls-wrapper">

        <div class="icon-wrapper">
            <img class="control-icon" id="mic-btn" src="{% static 'images/microphone.svg' %}" />
        </div>

        <div class="icon-wrapper">
            <img class="control-icon" id="camera-btn" src="{% static 'images/video.svg' %}" />
        </div>

        <div class="icon-wrapper">
            <img class="control-icon" id="leave-btn" src="{% static 'images/leave.svg' %}" />
        </div>

    </section>

    <!-- Button to open the side panel -->
    <button id="open-panel-btn" class="open-panel-btn">
        <img src="{% static 'images/group.png' %}">
    </button>

    <!-- Side Panel with current participants -->
    <div id="side-panel" class="side-panel hidden">
        <div id="panel-header">
            <h2>Participants</h2>
            <button id="close-panel-btn" class="close-panel-btn">X</button>
        </div>
        <div id="participants-list" class="participants-list">
            <!-- Participants will be listed here -->
        </div>
    </div>

</main>

<script type="text/javascript" src="{% static 'assets/AgoraRTC_N-4.22.1.js' %}"></script>
<script type="text/javascript" src="{% static 'js/streams.js' %}"></script>

<script>
    // Open the side panel
    const openPanelBtn = document.getElementById("open-panel-btn");
    const sidePanel = document.getElementById("side-panel");
    const closePanelBtn = document.getElementById("close-panel-btn");

    openPanelBtn.addEventListener("click", () => {
        sidePanel.classList.remove("hidden");
        sidePanel.classList.add("visible");
    });

    // Close the side panel
    closePanelBtn.addEventListener("click", () => {
        sidePanel.classList.remove("visible");
        sidePanel.classList.add("hidden");
    });


    const approvalPopup = document.getElementById("approval-popup");
    const requestList = document.getElementById("request-list");
    const roomNameElement = document.getElementById("room-name"); // Accessing the span with room name

    let isHost = true;  // Variable to store if the user is the host

    // Show popup if user is host and there are pending requests
    async function checkPendingRequests() {
        const roomName = roomNameElement.innerText;  // Get the room name from the span element
        try {
            // Fetch pending requests for the room
            const response = await fetch(`/check_pending_requests/${roomName}/`);
            const data = await response.json();

            // If the user is the host, set isHost to true
            if (data.is_host) {
                isHost = true;
            }
            else {
                isHost = false
            }

            if (data.status === "success") {
                const pendingRequests = data.pending_requests;
                if (pendingRequests.length > 0) {
                    // Display the popup if there are pending requests
                    requestList.innerHTML = "";  // Clear previous requests
                    pendingRequests.forEach(request => {

                        // Create elements for each request
                        const requestItem = document.createElement("div");
                        requestItem.classList.add("request-item");
                        requestItem.innerHTML = `
                            <p>Are you sure you wish to approve join for <strong><span id="member-name">${request.name}</span></strong>?</p>
                            <div class="popup-actions">
                                <button class="btn approve-btn" onclick="respondToJoinRequest('${request.user_id}', true)">Approve</button>
                                <button class="btn cancel-btn" onclick="respondToJoinRequest('${request.user_id}', false)">Deny</button>
                            </div>
                        `;
                        requestList.appendChild(requestItem);
                    });
                    approvalPopup.classList.remove("hidden");  // Show the popup
                } else {
                    approvalPopup.classList.add("hidden");  // Hide the popup if no requests
                }
            } else {
                console.log("Error checking pending requests: " + data.message);
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }

    // Respond to a join request (approve/deny)
    async function respondToJoinRequest(userId, approve) {
        const roomName = roomNameElement.innerText;  // Get the room name again when responding

        try {
            const response = await fetch(`/approve_join_request/${roomName}/${userId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie('csrftoken')
                },
                body: JSON.stringify({ user_id: userId, approve })
            });
            const data = await response.json();
            console.log(data.message);

            // Refresh the pending requests after response
            checkPendingRequests();
        } catch (error) {
            console.error("Error responding to join request:", error);
        }
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    // Poll for pending requests every 3 seconds, but only if the user is the host
    setInterval(() => {
        if (isHost) {
            checkPendingRequests();  // Poll for pending requests if the user is host
        }
    }, 3000);

    // Function to fetch and update the list of participants in the room
    async function updateParticipants() {
        const roomName = roomNameElement.innerText;  // Get the room name from the span element

        try {
            // Fetch participants for the room
            const response = await fetch(`/get_participants/${roomName}/`);
            const data = await response.json();

            if (data.status === "success") {
                const participantsList = document.getElementById("participants-list");

                // Clear the previous participant list
                participantsList.innerHTML = "";

                // Add each participant to the list
                data.participants.forEach(participant => {
                    const participantItem = document.createElement("p");
                    participantItem.textContent = participant.username;
                    participantItem.style.textTransform = "capitalize";  // Capitalize the username
                    participantsList.appendChild(participantItem);
                });
            } else {
                console.log("Error fetching participants: " + data.message);
            }
        } catch (error) {
            console.error("Error fetching participants:", error);
        }
    }

    // Call the updateParticipants function to populate the participant list on page load
    updateParticipants();

    // A polling mechanism to periodically update the participants list
    setInterval(updateParticipants, 5000);  // Update every 5 seconds
</script>


{% endblock content %}